// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUM DE ROLES
// ============================================
enum UserRole {
  USER
  EVALUATOR
  ADMIN
}

// ============================================
// MODELO DE USUARIOS
// ============================================
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  firstName String?
  lastName  String?
  role      UserRole @default(USER) // ← SOLO AGREGAR ESTA LÍNEA

  isEmailVerified Boolean  @default(false)
  emailVerificationToken String? @unique
  emailVerificationExpires DateTime?

  passwordResetToken String? @unique
  passwordResetExpires DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLoginAt DateTime?

  // Relaciones
  queries UserQuery[]
  qualitativeEvaluations QualitativeEvaluation[]
  sessions UserSession[]
  preferences UserPreferences?

  @@map("users")
}

// ============================================
// SESIONES DE USUARIO (para logout en todos los dispositivos)
// ============================================
model UserSession {
  id           Int      @id @default(autoincrement())
  userId       Int
  token        String   @unique
  deviceInfo   String?  // "Chrome en Windows", "Safari en iPhone", etc.
  ipAddress    String?
  lastActivity DateTime @default(now())
  createdAt    DateTime @default(now())
  expiresAt    DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

// ============================================
// PREFERENCIAS DE USUARIO
// ============================================
model UserPreferences {
  id              Int      @id @default(autoincrement())
  userId          Int      @unique
  promptFontSize  Int      @default(14)    // Tamaño de fuente para prompts
  promptFontFamily String  @default("mono") // mono, sans, serif
  theme           String   @default("dark") // dark, light, system
  language        String   @default("es")   // es, en
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

// MODELO 1: Consultas/Prompts de usuarios
model UserQuery {
  id             Int             @id @default(autoincrement())
  userId         Int             // ← NUEVO: relación con usuario
  userPrompt     String
  promptCategory String?
  createdAt      DateTime        @default(now())
  status         String          @default("processing")

  // Relaciones
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  generatedCodes GeneratedCode[]

  @@map("user_queries")
}

model GeneratedCode {
  id               Int      @id @default(autoincrement())
  queryId          Int
  llmName          String
  codeContent      String
  generatedAt      DateTime @default(now())
  generationTimeMs Int?

  // Relaciones
  query            UserQuery         @relation(fields: [queryId], references: [id], onDelete: Cascade)
  metrics          CodeMetrics?
  testExecutions   TestExecution[]
  securityFindings SecurityFinding[]
  qualitativeEvaluations QualitativeEvaluation[] // ← SOLO AGREGAR ESTA LÍNEA

  @@map("generated_codes")
}

// MODELO 3: Métricas cuantitativas (las 14 métricas)
model CodeMetrics {
  id     Int @id @default(autoincrement())
  codeId Int @unique

  // CORRECCIÓN (3 métricas)
  passRate           Float? @default(0)
  errorHandlingScore Float? @default(0)
  runtimeErrorRate   Float? @default(0)

  // EFICIENCIA (3 métricas)
  avgExecutionTime      Float? // milisegundos
  memoryUsage           Float? // MB
  algorithmicComplexity Int?   @default(1)

  // MANTENIBILIDAD (4 métricas)
  cyclomaticComplexity Int?   @default(1)
  linesOfCode          Int?   @default(0)
  nestingDepth         Int?   @default(1)
  cohesionScore        Float? @default(100)

  // SEGURIDAD (4 métricas)
  xssVulnerabilities       Int? @default(0)
  injectionVulnerabilities Int? @default(0)
  hardcodedSecrets         Int? @default(0)
  unsafeOperations         Int? @default(0)

  // PUNTUACIONES FINALES
  totalScore Float?   @default(0)
  analyzedAt DateTime @default(now())

  // Relaciones
  code GeneratedCode @relation(fields: [codeId], references: [id], onDelete: Cascade)

  @@map("code_metrics")
}

// MODELO 4: Casos de prueba ejecutados
model TestExecution {
  id              Int      @id @default(autoincrement())
  codeId          Int
  testCaseNumber  Int
  testInput       Json // inputs del test en formato JSON
  expectedOutput  String?
  actualOutput    String?
  passed          Boolean  @default(false)
  executionTimeMs Float?
  errorMessage    String?
  executedAt      DateTime @default(now())

  // Relaciones
  code GeneratedCode @relation(fields: [codeId], references: [id], onDelete: Cascade)

  @@map("test_executions")
}

// MODELO 5: Vulnerabilidades detectadas
model SecurityFinding {
  id                Int      @id @default(autoincrement())
  codeId            Int
  vulnerabilityType String // 'xss', 'injection', 'secrets', 'unsafe'
  severity          String // 'low', 'medium', 'high', 'critical'
  lineNumber        Int?
  patternMatched    String?
  description       String?
  detectedAt        DateTime @default(now())

  // Relaciones
  code GeneratedCode @relation(fields: [codeId], references: [id], onDelete: Cascade)

  @@map("security_findings")
}

model QualitativeEvaluation {
  id                Int      @id @default(autoincrement())
  codeId            Int
  evaluatorId       Int

  // Criterios de evaluación (escala 1-5)
  readabilityScore  Int      // Legibilidad
  clarityScore      Int      // Claridad
  structureScore    Int      // Estructura
  documentationScore Int     // Documentación

  // Score total (promedio)
  totalScore        Float

  // Comentarios del evaluador
  generalComments   String?  @db.Text
  readabilityComments String? @db.Text
  clarityComments   String?  @db.Text
  structureComments String?  @db.Text
  documentationComments String? @db.Text

  evaluatedAt       DateTime @default(now())

  // Relaciones
  code              GeneratedCode @relation(fields: [codeId], references: [id], onDelete: Cascade)
  evaluator         User          @relation(fields: [evaluatorId], references: [id])

  // Un evaluador solo puede evaluar un código una vez
  @@unique([codeId, evaluatorId])
  @@map("qualitative_evaluations")
}
